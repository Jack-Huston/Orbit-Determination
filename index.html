<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>2D Orbit + EKF + Linear Control Demo</title>
    <link rel="stylesheet" href="orbit-sim.css" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <div class="brand-mark" aria-hidden="true"></div>
        <div class="brand-text">
          <div class="brand-title">Orbit Nav Demo</div>
          <div class="brand-sub">2D ECI · RK4 truth · EKF · 12 rotating ground stations · linear control</div>
        </div>
      </div>
      <div class="statusline">
        <div class="pill"><span class="dot dot-truth"></span>Truth</div>
        <div class="pill"><span class="dot dot-est"></span>EKF</div>
        <div class="pill"><span class="dot dot-meas"></span>Meas</div>
        <div class="pill"><span class="dot dot-ctrl"></span>Control</div>
        <div class="pill warn" id="pillDisturb">Disturbance OFF</div>
        <div class="pill warn" id="pillSat">Saturation OK</div>
        <div class="pill warn" id="pillImpact" style="display:none;">IMPACT</div>
      </div>
    </header>

    <main class="layout">
      <section class="card orbit-card">
        <div class="card-head">
          <div class="card-title">Orbit View</div>
          <div class="card-actions">
            <button class="btn" id="btnResetView" type="button">Reset View</button>
            <button class="btn" id="btnZoomCraft" type="button">Zoom to Craft</button>
          </div>
        </div>

        <div class="orbit-wrap">
          <canvas id="orbitCanvas" aria-label="Orbit view canvas"></canvas>

          <div class="hud">
            <div class="hud-row">
              <div class="hud-item">
                <div class="hud-label">t (s)</div>
                <div class="hud-value" id="hudTime">0.00</div>
              </div>
              <div class="hud-item">
                <div class="hud-label">step</div>
                <div class="hud-value" id="hudStep">0</div>
              </div>
              <div class="hud-item">
                <div class="hud-label">Δt (s)</div>
                <div class="hud-value" id="hudDt">10</div>
              </div>
              <div class="hud-item">
                <div class="hud-label">visible</div>
                <div class="hud-value" id="hudVisible">0</div>
              </div>
            </div>
            <div class="hud-row">
              <div class="hud-item">
                <div class="hud-label">mode</div>
                <div class="hud-value" id="hudMode">Paused</div>
              </div>
              <div class="hud-item">
                <div class="hud-label">speed</div>
                <div class="hud-value" id="hudSpeed">10×</div>
              </div>
              <div class="hud-item">
                <div class="hud-label">NEES</div>
                <div class="hud-value" id="hudNees">–</div>
              </div>
              <div class="hud-item">
                <div class="hud-label">NIS</div>
                <div class="hud-value" id="hudNis">–</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Added: relative position + covariance ellipse panel (new, additive only) -->
        <div class="ellipse-wrap">
          <div class="ellipse-head">
            <div class="ellipse-title">Relative position &amp; covariance</div>
            <div class="ellipse-scale" id="ellipseScale">–</div>
          </div>
          <canvas id="ellipseCanvas" aria-label="Relative position and covariance ellipse plot"></canvas>
          <div class="micro" id="ellipseHelp">
            Centered at the EKF estimate (0,0). The dot shows the truth offset (truth − estimate) at the most recent measurement update.
            Ellipses show 1σ, 2σ, and 3σ position uncertainty from the EKF covariance.
          </div>
        </div>

        <div class="hint"> Pan: drag · Zoom: scroll · Space: Run/Pause · R: Reset · S: Step </div>
      </section>

      <aside class="card controls-card">
        <div class="card-head">
          <div class="card-title">Simulation / Controls</div>

          <!-- Moved (layout only): speedbar into the card header (IDs unchanged) -->
          <div class="card-actions">
            <div class="speedbar" aria-label="simulation speed">
              <button class="btn speedbtn" data-speed="1" type="button">1×</button>
              <button class="btn speedbtn active" data-speed="10" type="button">10×</button>
              <button class="btn speedbtn" data-speed="100" type="button">100×</button>
              <button class="btn speedbtn" data-speed="1000" type="button">1000×</button>
              <button class="btn speedbtn" data-speed="10000" type="button">10000×</button>
            </div>
          </div>
        </div>

        <div class="controls">
          <div class="row">
            <button class="btn primary" id="btnRunPause" type="button">Run</button>
            <button class="btn" id="btnStep" type="button">Step</button>
            <button class="btn danger" id="btnReset" type="button">Reset</button>
          </div>

          <div class="section orbit-ic-section">
            <div class="section-title">Initial condition / desired orbit</div>
            <div class="grid">
              <label class="field">
                <span>Perigee alt (km)</span>
                <input id="inpPerigeeAlt" type="number" min="150" max="2000" step="10" value="300" />
                <div class="bounds">min 150 · max 2000</div>
              </label>

              <label class="field">
                <span>Eccentricity</span>
                <input id="inpEcc" type="number" min="0" max="0.6" step="0.001" value="0.0" />
                <div class="bounds">Controller requires e = 0</div>
              </label>
            </div>

            <div class="micro">
              Perigee radius r<sub>p</sub> = R<sub>E</sub> + altitude. Eccentricity sets an elliptical orbit (initialized at perigee).
            </div>
          </div>

          <div class="grid">
            <label class="field">
              <span>Δt (s)</span>
              <input id="inpDt" type="number" min="1" max="120" step="1" value="10" />
              <div class="bounds">min 1 · max 120</div>
            </label>
          </div>

          <div class="section">
            <div class="section-title">Measurement noise (per station)</div>
            <div class="grid">
              <label class="field">
                <span>Measurement noise</span>
                <select id="selMeasNoise">
                  <option value="on" selected>On</option>
                  <option value="off">Off</option>
                </select>
              </label>
            </div>

            <div class="grid3">
              <label class="field">
                <span>Range standard deviation (km)</span>
                <input id="inpSigRho" type="number" min="0" step="0.001" value="0.1" />
                <div class="bounds">min 0</div>
              </label>

              <label class="field">
                <span>Range-rate standard deviation (km/s)</span>
                <input id="inpSigRhoDot" type="number" min="0" step="0.001" value="1.0" />
                <div class="bounds">min 0</div>
              </label>

              <label class="field">
                <span>Bearing standard deviation (rad)</span>
                <input id="inpSigPhi" type="number" min="0" step="0.001" value="0.1" />
                <div class="bounds">min 0</div>
              </label>
            </div>

            <div class="micro" id="measHelp">
              When enabled, each visible station generates (ρ, ρ̇, φ) and adds Gaussian noise using the standard deviations above.
              The EKF uses the same values to build R, so turning noise off should tighten innovations and consistency metrics.
            </div>
          </div>

          <div class="section">
            <div class="section-title">Process noise / disturbance acceleration</div>
            <div class="grid">
              <label class="field">
                <span>Disturbance</span>
                <select id="selDisturb">
                  <option value="off" selected>Off</option>
                  <option value="on">On</option>
                </select>
              </label>

              <label class="field">
                <span>Disturbance accel magnitude (km/s²)</span>
                <input id="inpSigA" type="number" min="0" step="1e-8" value="1e-7" />
                <div class="bounds">min 0</div>
              </label>
            </div>

            <div class="row tight">
              <button class="btn" id="btnPerturbOrbit" type="button">Perturb Orbit</button>
            </div>

            <div class="micro" id="distHelp">
              <b>Disturbance accel</b> applies a constant acceleration bias (same direction every step) to the truth dynamics.
              <b>Perturb Orbit</b> applies a one-time small velocity “kick” so you can watch the controller drive the orbit back.
            </div>
          </div>

          <div class="section" id="ctrlSection">
            <div class="section-title">Controller (thruster acceleration)</div>
            <div class="grid">
              <label class="field">
                <span>Controller type</span>
                <select id="selCtrl">
                  <option value="off" selected>Off</option>
                  <option value="lqr">LQR</option>
                </select>
              </label>

              <label class="field">
                <span>MAX THRUSTER ACCELERATION (G)</span>
                <input id="inpUmaxG" type="number" min="0" step="0.001" value="0.01" />
                <div class="bounds">min 0</div>
              </label>
            </div>

            <div class="micro warnnote" id="ctrlEccNote" style="display:none;">
              Controller is disabled because this LQR is linearized for a circular orbit. Set eccentricity to 0 to enable it.
            </div>
          </div>
        </div>
      </aside>

      <section class="card plots-card">
        <div class="card-head">
          <div class="card-title">Diagnostics</div>
          <div class="diag-actions">
            <div class="tabs" role="tablist" aria-label="plot tabs">
              <button class="tab active" data-tab="tabStates" type="button">States</button>
              <button class="tab" data-tab="tabErrors" type="button">Errors</button>
              <button class="tab" data-tab="tabMeas" type="button">Meas</button>
              <button class="tab" data-tab="tabNees" type="button">NEES/NIS</button>
              <button class="tab" data-tab="tabCtrl" type="button">Control</button>
            </div>

            <label class="windowctl" aria-label="plot window selector">
              <span>Window</span>
              <select id="selPlotWindow">
                <option value="3600">1h</option>
                <option value="10800" selected>3h</option>
                <option value="21600">6h</option>
                <option value="43200">12h</option>
              </select>
            </label>
          </div>
        </div>

        <div class="tabpanes">
          <div class="pane active" id="tabStates">
            <div class="plotgrid">
              <div class="plotcard">
                <div class="plotlabel">X position</div>
                <canvas class="plot" id="pltX"></canvas>
              </div>
              <div class="plotcard">
                <div class="plotlabel">Y position</div>
                <canvas class="plot" id="pltY"></canvas>
              </div>
              <div class="plotcard">
                <div class="plotlabel">X velocity</div>
                <canvas class="plot" id="pltXd"></canvas>
              </div>
              <div class="plotcard">
                <div class="plotlabel">Y velocity</div>
                <canvas class="plot" id="pltYd"></canvas>
              </div>
            </div>
          </div>

          <div class="pane" id="tabErrors">
            <div class="plotgrid">
              <div class="plotcard">
                <div class="plotlabel">X error ±2σ</div>
                <canvas class="plot" id="pltErrX"></canvas>
              </div>
              <div class="plotcard">
                <div class="plotlabel">Y error ±2σ</div>
                <canvas class="plot" id="pltErrY"></canvas>
              </div>
              <div class="plotcard">
                <div class="plotlabel">Ẋ error ±2σ</div>
                <canvas class="plot" id="pltErrXd"></canvas>
              </div>
              <div class="plotcard">
                <div class="plotlabel">Ẏ error ±2σ</div>
                <canvas class="plot" id="pltErrYd"></canvas>
              </div>
            </div>
          </div>

          <div class="pane" id="tabMeas">
            <div class="plotgrid plotgrid-meas">
              <div class="plotcard">
                <div class="plotlabel">ρ (km): meas dots vs predicted line</div>
                <canvas class="plot" id="pltRho"></canvas>
              </div>
              <div class="plotcard">
                <div class="plotlabel">ρ̇ (km/s): meas dots vs predicted line</div>
                <canvas class="plot" id="pltRhoDot"></canvas>
              </div>
              <div class="plotcard">
                <div class="plotlabel">φ (rad): meas dots vs predicted line</div>
                <canvas class="plot" id="pltPhi"></canvas>
              </div>
            </div>

            <div class="stationboard-wrap">
              <div class="stationboard-title">Stations</div>
              <div class="stationboard" id="stationBoard" aria-label="Station board"></div>
              <div class="micro stationboard-micro">
                Each box is one station. ACTIVE means that station produced a measurement at the last EKF update.
              </div>
            </div>
          </div>

          <div class="pane" id="tabNees">
            <div class="plotgrid plotgrid-nees">
              <div class="plotcard">
                <div class="plotlabel">NEES (df=4) + 95% bounds</div>
                <canvas class="plot" id="pltNEES"></canvas>
              </div>
              <div class="plotcard">
                <div class="plotlabel">NIS (df=3m) + 95% bounds</div>
                <canvas class="plot" id="pltNIS"></canvas>
              </div>
            </div>

            <div class="micro" id="neesHelp">
              <b>NEES</b> checks state consistency: e = x<sub>true</sub> − x̂, and NEES = eᵀP⁻¹e.
              <b>NIS</b> checks measurement consistency using the innovation and its covariance.
              If your filter is well tuned, these curves should usually stay inside the 95% bounds (occasional violations are expected).
            </div>
          </div>

          <div class="pane" id="tabCtrl">
            <div class="notice" id="ctrlNotice" style="display:none;">
              <div class="notice-title">Nothing for the controller to correct yet</div>
              <div class="notice-body" id="ctrlNoticeBody">
                Turn on LQR (requires eccentricity = 0) and/or enable a disturbance.
                Or apply a one-time orbit perturbation to watch recovery.
              </div>
              <div class="notice-actions">
                <button class="btn" id="btnPerturbOrbit2" type="button">Perturb Orbit</button>
              </div>
            </div>

            <div class="plotgrid">
              <div class="plotcard">
                <div class="plotlabel">u_r, u_t (km/s²)</div>
                <canvas class="plot" id="pltUrt"></canvas>
              </div>
              <div class="plotcard">
                <div class="plotlabel">‖u‖ (km/s²) + u_max</div>
                <canvas class="plot" id="pltUm"></canvas>
              </div>
              <div class="plotcard">
                <div class="plotlabel">Controller state: δr (km), δθ (rad)</div>
                <canvas class="plot" id="pltCtrlErr"></canvas>
              </div>
              <div class="plotcard ctrl-status">
                <div class="plotlabel">Thrusters</div>
                <div class="statusbox ok" id="ctrlSatBox" aria-label="Thruster saturation status">
                  <div class="statusbox-left">
                    <div class="statusbox-title">Saturation</div>
                    <div class="statusbox-value" id="ctrlSatText">OK</div>
                  </div>
                  <div class="statusbox-right">
                    <div class="statusbox-sub">‖u‖ / u<sub>max</sub></div>
                    <div class="statusbox-mono" id="ctrlSatFrac">0.00</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="micro">
              The thrust arrow in the orbit view shows the applied control acceleration.
              It disappears automatically when control is off or zero.
            </div>
          </div>
        </div>

        <div class="hint small"> Tip: when paused, hover plots for coordinates; drag to pan, scroll to zoom. </div>
      </section>
    </main>

    <footer class="footer">
      <div>All client-side. Lucide is used only for the station icon.</div>
    </footer>

    <!-- Lucide icon dependency (allowed) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="orbit-sim.js"></script>
  </body>
</html>
