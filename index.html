<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orbit OD + EKF + Orbit Control (Client-side)</title>
  <link rel="stylesheet" href="orbit-sim.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand__dot"></div>
      <div class="brand__title">Orbit OD + EKF + Orbit Control</div>
      <div class="brand__sub">2D two-body • rotating ground stations • range/ρ̇/φ • EKF • disturbance rejection</div>
    </div>

    <div class="hud">
      <div class="hud__chip" id="chipRun"><span class="hud__label">Status</span><span class="hud__value" id="readoutRun">PAUSED</span></div>
      <div class="hud__chip"><span class="hud__label">t</span><span class="hud__value" id="readoutTime">0.0 s</span></div>
      <div class="hud__chip"><span class="hud__label">Δt</span><span class="hud__value" id="readoutDt">1.0 s</span></div>
      <div class="hud__chip"><span class="hud__label">Visible</span><span class="hud__value" id="readoutVisible">0</span></div>
      <div class="hud__chip"><span class="hud__label">Δv</span><span class="hud__value" id="readoutDV">0.0 m/s</span></div>
    </div>

    <div class="actions">
      <button class="btn btn--primary" id="btnToggleRun">Run</button>
      <button class="btn" id="btnStep">Step</button>
      <button class="btn" id="btnReset">Reset</button>
      <div class="seg">
        <button class="btn btn--seg" data-speed="1">×1</button>
        <button class="btn btn--seg" data-speed="5">×5</button>
        <button class="btn btn--seg" data-speed="20">×20</button>
      </div>
    </div>
  </header>

  <main class="layout">
    <aside class="sidebar">
      <section class="card">
        <div class="card__title">Simulation</div>
        <div class="grid2">
          <label class="field">
            <span>Time step Δt (s)</span>
            <input id="inpDt" type="number" min="0.1" max="60" step="0.1" value="5" />
          </label>
          <label class="field">
            <span>Meas rate (every N steps)</span>
            <input id="inpMeasEvery" type="number" min="1" max="60" step="1" value="1" />
          </label>
        </div>

        <div class="row">
          <button class="btn btn--ghost" id="btnZoomCraft">Zoom to craft</button>
          <button class="btn btn--ghost" id="btnResetView">Reset view</button>
        </div>

        <div class="help">
          Units: km, km/s, rad, s. Earth constants fixed (μ, R<sub>e</sub>, ω<sub>e</sub>).
        </div>
      </section>

      <section class="card">
        <div class="card__title">Desired orbit (reference)</div>
        <div class="grid2">
          <label class="field">
            <span>Perigee altitude (km)</span>
            <input id="inpTgtAlt" type="number" min="150" max="40000" step="10" value="300" />
          </label>
          <label class="field">
            <span>Eccentricity e</span>
            <input id="inpTgtE" type="number" min="0" max="0.6" step="0.01" value="0.00" />
          </label>
        </div>

        <details class="adv">
          <summary>Advanced</summary>
          <div class="grid2">
            <label class="field">
              <span>Arg. of periapsis ω (deg)</span>
              <input id="inpTgtW" type="number" min="-180" max="180" step="1" value="0" />
            </label>
            <label class="field">
              <span>Reference phase align</span>
              <select id="selPhase">
                <option value="angle" selected>Match current inertial angle</option>
                <option value="perigee">Start at perigee (θ=ω)</option>
              </select>
            </label>
          </div>
        </details>

        <div class="row">
          <button class="btn btn--primary" id="btnApplyTarget">Apply target orbit</button>
          <button class="btn" id="btnHoldHere">Hold current orbit</button>
        </div>

        <div class="mini">
          <div><span class="k">a</span> <span class="v" id="readoutA">—</span></div>
          <div><span class="k">r<sub>a</sub></span> <span class="v" id="readoutRa">—</span></div>
          <div><span class="k">T</span> <span class="v" id="readoutPeriod">—</span></div>
        </div>
      </section>

      <section class="card">
        <div class="card__title">Controller</div>

        <div class="row">
          <label class="toggle">
            <input id="tglCtrl" type="checkbox" checked />
            <span>Enable control</span>
          </label>
          <label class="toggle">
            <input id="tglCtrlUseEKF" type="checkbox" checked />
            <span>Use EKF estimate</span>
          </label>
        </div>

        <div class="grid2">
          <label class="field">
            <span>Mode</span>
            <select id="selCtrlMode">
              <option value="track" selected>Nonlinear tracking (PI-D)</option>
              <option value="lqr">Linear LQR (near-circular)</option>
            </select>
          </label>
          <label class="field">
            <span>Max accel (g)</span>
            <input id="inpUMaxG" type="number" min="0.0001" max="0.05" step="0.0001" value="0.01" />
          </label>
        </div>

        <label class="field">
          <span>Aggressiveness</span>
          <input id="inpAgg" type="range" min="0.2" max="3" step="0.05" value="1" />
        </label>

        <details class="adv">
          <summary>Gains</summary>
          <div class="grid2">
            <label class="field">
              <span>Kp (1/s²)</span>
              <input id="inpKp" type="number" step="1e-7" value="2e-6" />
            </label>
            <label class="field">
              <span>Kd (1/s)</span>
              <input id="inpKd" type="number" step="1e-4" value="8e-4" />
            </label>
            <label class="field">
              <span>Ki (1/s³)</span>
              <input id="inpKi" type="number" step="1e-10" value="2e-9" />
            </label>
            <label class="field">
              <span>Integral clamp (km·s)</span>
              <input id="inpIClamp" type="number" step="10" value="5000" />
            </label>
          </div>

          <div class="help">
            Tracking control law (inertial):<br/>
            <code>u = a_ref − a_hat + Kp·(r_ref−r_hat) + Kd·(v_ref−v_hat) + Ki·∫(r_ref−r_hat)dt</code>
          </div>
        </details>

        <div class="callout callout--warn" id="calloutCtrlSat" hidden>
          Control saturated at max accel.
        </div>
      </section>

      <section class="card">
        <div class="card__title">Disturbances & noise</div>

        <div class="row">
          <label class="toggle">
            <input id="tglTruthDist" type="checkbox" />
            <span>Truth accel disturbance</span>
          </label>
          <span class="pill pill--warn" id="pillDist" hidden>Truth random-walk</span>
        </div>

        <div class="grid2">
          <label class="field">
            <span>Model</span>
            <select id="selDistModel">
              <option value="gm" selected>Gauss–Markov</option>
              <option value="white">White</option>
            </select>
          </label>
          <label class="field">
            <span>σ<sub>a</sub> (m/s²)</span>
            <input id="inpDistSigma" type="number" step="0.00001" value="0.00020" />
          </label>
        </div>

        <label class="field">
          <span>GM correlation τ (s)</span>
          <input id="inpDistTau" type="number" min="10" max="50000" step="10" value="600" />
        </label>

        <hr class="sep" />

        <div class="row">
          <label class="toggle">
            <input id="tglMeasNoise" type="checkbox" checked />
            <span>Measurement noise</span>
          </label>
        </div>

        <div class="grid3">
          <label class="field">
            <span>σ<sub>ρ</sub> (km)</span>
            <input id="inpSigRho" type="number" step="0.01" value="0.20" />
          </label>
          <label class="field">
            <span>σ<sub>ρ̇</sub> (km/s)</span>
            <input id="inpSigRhod" type="number" step="0.0001" value="0.0020" />
          </label>
          <label class="field">
            <span>σ<sub>φ</sub> (rad)</span>
            <input id="inpSigPhi" type="number" step="0.0001" value="0.0020" />
          </label>
        </div>

        <details class="adv">
          <summary>Filter tuning</summary>
          <div class="grid2">
            <label class="field">
              <span>EKF accel σ<sub>Q</sub> (m/s²)</span>
              <input id="inpQsigma" type="number" step="0.00001" value="0.00005" />
            </label>
            <label class="field">
              <span>Consistency α</span>
              <input id="inpAlpha" type="number" min="0.01" max="0.2" step="0.01" value="0.05" />
            </label>
          </div>
        </details>
      </section>

      <section class="card">
        <div class="card__title">Ground stations</div>
        <div class="stationBoard" id="stationBoard"></div>
        <div class="help">When a station is measuring, the link and “data squiggle” use that station’s color.</div>
      </section>
    </aside>

    <section class="main">
      <div class="vizCard">
        <div class="vizTop">
          <div class="vizTop__left">
            <div class="legend">
              <span class="sw sw--truth"></span> Truth
              <span class="sw sw--est"></span> EKF
              <span class="sw sw--ref"></span> Reference
            </div>
          </div>
          <div class="vizTop__right">
            <div class="small" id="readoutOrbit">—</div>
          </div>
        </div>

        <div class="orbitWrap">
          <canvas id="orbitCanvas"></canvas>
          <div class="overlay overlay--tl" id="overlayWarn" hidden>Disturbances enabled</div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab is-active" data-tab="states">States</button>
        <button class="tab" data-tab="errors">Errors</button>
        <button class="tab" data-tab="meas">Measurements</button>
        <button class="tab" data-tab="traj">Trajectory</button>
        <button class="tab" data-tab="cons">NEES / NIS</button>
        <button class="tab" data-tab="ctrl">Control</button>
      </div>

      <div class="panes">
        <div class="pane is-active" data-pane="states"><canvas id="plotStates"></canvas></div>
        <div class="pane" data-pane="errors"><canvas id="plotErrors"></canvas></div>
        <div class="pane" data-pane="meas"><canvas id="plotMeas"></canvas></div>
        <div class="pane" data-pane="traj"><canvas id="plotTraj"></canvas></div>
        <div class="pane" data-pane="cons"><canvas id="plotCons"></canvas></div>
        <div class="pane" data-pane="ctrl"><canvas id="plotCtrl"></canvas></div>
      </div>

      <footer class="footer">
        Tip: Pan/zoom the orbit view any time. Plot pan/zoom is enabled only when paused.
      </footer>
    </section>
  </main>

  <script src="orbit-sim.js"></script>
</body>
</html>
