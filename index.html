<!-- index.html
     Orbit Determination + EKF Demo (2D) — portfolio interactive
     Notes:
     - This page is intentionally self-contained (no external JS libs).
     - The JS expects specific IDs/data attributes for tabs, plots, controls, and readouts.
     - Keep the structure/IDs intact when editing layout.
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orbit Determination + EKF Simulator</title>
  <link rel="stylesheet" href="orbit-sim.css" />
</head>

<body>
  <!-- Top nav (simple + clean; your site can wrap this in your own global navbar) -->
  <header class="topbar" role="banner">
    <div class="topbar__inner">
      <a class="backlink" href="../index.html" aria-label="Back to portfolio home">
        ← Back
      </a>

      <div class="brand">
        <span class="brand__title">Orbit Determination</span>
        <span class="brand__sub">Nonlinear truth + EKF (range / range-rate / angle)</span>
      </div>

      <div class="topbar__status" aria-live="polite">
        <span id="statusRun" class="pill pill--idle">PAUSED</span>
        <span class="mono" id="hudWallClock">—</span>
      </div>
    </div>
  </header>

  <!-- Hero / intro -->
  <section class="hero" aria-label="Project overview">
    <div class="hero__inner">
      <div class="hero__left">
        <div class="badge">Interactive Demo</div>
        <h1 class="hero__title">Deep Space Network-style Tracking + EKF</h1>
        <p class="hero__text">
          A 2D Earth-orbit tracking simulation with a nonlinear truth model and an Extended Kalman Filter (EKF).
          Ground stations provide <span class="mono">ρ</span>, <span class="mono">ρ̇</span>, and <span class="mono">φ</span> measurements when visible.
          Live plots show state estimates, errors, measurement residuals, and filter consistency tests (NEES/NIS).
        </p>

        <div class="hero__cta">
          <button id="btnToggleRun" class="btn btn--primary" type="button">Run</button>
          <button id="btnStep" class="btn btn--ghost" type="button">Step</button>
          <button id="btnReset" class="btn btn--ghost" type="button">Reset</button>
        </div>

        <div class="chips" aria-label="Simulation speed controls">
          <button id="spd1" class="chip is-active" type="button" data-speed="1">1×</button>
          <button id="spd10" class="chip" type="button" data-speed="10">10×</button>
          <button id="spd100" class="chip" type="button" data-speed="100">100×</button>
          <button id="spd1000" class="chip" type="button" data-speed="1000">1000×</button>
        </div>
      </div>

      <div class="hero__right">
        <div class="stats" role="group" aria-label="Live simulation readouts">
          <div class="stat">
            <div class="stat__label">Sim time</div>
            <div class="stat__value mono" id="readoutTime">0.0 s</div>
            <div class="stat__hint mono" id="readoutTimeFine">t = 0.00 s</div>
          </div>
          <div class="stat">
            <div class="stat__label">Step</div>
            <div class="stat__value mono" id="readoutStep">0</div>
            <div class="stat__hint">Δt set below</div>
          </div>
          <div class="stat">
            <div class="stat__label">Stations visible</div>
            <div class="stat__value mono" id="readoutVisible">0</div>
            <div class="stat__hint">Measurements every Δt</div>
          </div>

          <div class="divider"></div>

          <div class="stat stat--small">
            <div class="stat__label">Last measurement (example)</div>
            <div class="stat__value mono">
              ρ: <span id="roRho">—</span>
            </div>
            <div class="stat__value mono">
              ρ̇: <span id="roRhod">—</span>
            </div>
            <div class="stat__value mono">
              φ: <span id="roPhi">—</span>
            </div>
          </div>

          <div class="stat stat--small">
            <div class="stat__label">Consistency</div>
            <div class="stat__value mono">NEES: <span id="roNEES">—</span></div>
            <div class="stat__value mono">NIS: <span id="roNIS">—</span></div>
            <div class="stat__value mono">‖x̂−x‖: <span id="roErrNorm">—</span></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main content -->
  <main class="main" role="main">
    <div class="layout">
      <!-- Left: settings -->
      <aside class="panel panel--settings" aria-label="Settings and controls">
        <div class="panel__header">
          <h2 class="panel__title">Controls</h2>
          <p class="panel__subtitle">Adjust Δt and noise assumptions live. Keep changes small for stable EKF behavior.</p>
        </div>

        <div class="panel__body">
          <!-- Simulation -->
          <section class="card" aria-label="Simulation settings">
            <div class="card__head">
              <h3 class="card__title">Simulation</h3>
              <div class="card__right">
                <button id="btnApplyIC" class="btn btn--tiny" type="button">Apply IC</button>
              </div>
            </div>

            <div class="grid2">
              <label class="field">
                <span class="field__label">Δt (s)</span>
                <input id="inpDt" class="field__input" type="number" min="1" max="120" step="1" value="10" />
                <span class="field__hint">Measurement cadence (and filter update cadence).</span>
              </label>

              <label class="field">
                <span class="field__label">Max steps</span>
                <input id="inpSteps" class="field__input" type="number" min="1000" step="1000" value="1000000" />
                <span class="field__hint">Stops automatically at this count.</span>
              </label>
            </div>

            <div class="divider divider--thin"></div>

            <!-- Initial condition in orbital elements (2D) -->
            <div class="subhead">Initial orbit (2D)</div>

            <div class="grid2">
              <label class="field">
                <span class="field__label">Periapsis altitude (km)</span>
                <input id="inpRpAlt" class="field__input" type="number" min="200" max="40000" step="10" value="300" />
                <span class="field__hint">Must stay above atmosphere; constrained by validator.</span>
              </label>

              <label class="field">
                <span class="field__label">Eccentricity e</span>
                <input id="inpEcc" class="field__input" type="number" min="0" max="0.8" step="0.01" value="0.05" />
                <span class="field__hint">Elliptical: 0 ≤ e &lt; 1 (limited for stability).</span>
              </label>

              <label class="field">
                <span class="field__label">True anomaly ν (deg)</span>
                <input id="inpNuDeg" class="field__input" type="number" min="-180" max="180" step="1" value="0" />
                <span class="field__hint">Angle from periapsis to current position.</span>
              </label>

              <label class="field">
                <span class="field__label">Argument of periapsis ω (deg)</span>
                <input id="inpArgpDeg" class="field__input" type="number" min="-180" max="180" step="1" value="0" />
                <span class="field__hint">Orbit rotation in the inertial plane.</span>
              </label>
            </div>

            <div class="callout" id="icValidity" aria-live="polite">
              <div class="callout__dot"></div>
              <div class="callout__text">
                IC status: <span class="mono" id="icValidityText">—</span>
              </div>
            </div>
          </section>

          <!-- Noise toggles + truth -->
          <section class="card" aria-label="Truth noise">
            <div class="card__head">
              <h3 class="card__title">Truth noise</h3>
            </div>

            <div class="grid2">
              <label class="toggle">
                <input id="tglProcNoise" type="checkbox" checked />
                <span class="toggle__pill"></span>
                <span class="toggle__text">
                  Process noise (truth)
                  <span class="toggle__hint mono">a ~ N(0,Q)</span>
                </span>
              </label>

              <label class="toggle">
                <input id="tglMeasNoise" type="checkbox" checked />
                <span class="toggle__pill"></span>
                <span class="toggle__text">
                  Measurement noise (truth)
                  <span class="toggle__hint mono">y ~ h(x)+v</span>
                </span>
              </label>
            </div>

            <div class="grid3">
              <label class="field">
                <span class="field__label">Qtrue ax (km/s²)²</span>
                <input id="inpQtrueAx" class="field__input" type="number" step="1e-10" value="1e-8" />
                <span class="field__hint">Acceleration variance in X.</span>
              </label>

              <label class="field">
                <span class="field__label">Qtrue ay (km/s²)²</span>
                <input id="inpQtrueAy" class="field__input" type="number" step="1e-10" value="1e-8" />
                <span class="field__hint">Acceleration variance in Y.</span>
              </label>

              <div class="field field--note">
                <span class="field__label">Tip</span>
                <div class="field__hint">
                  If your MATLAB truth data looked noisier, increase Qtrue and/or Rtrue (below).
                </div>
              </div>
            </div>

            <div class="grid3">
              <label class="field">
                <span class="field__label">σρ true (km)</span>
                <input id="inpRtrueRho" class="field__input" type="number" min="0" step="0.01" value="0.2" />
                <span class="field__hint">Range std dev.</span>
              </label>

              <label class="field">
                <span class="field__label">σρ̇ true (km/s)</span>
                <input id="inpRtrueRhod" class="field__input" type="number" min="0" step="0.0001" value="0.002" />
                <span class="field__hint">Range-rate std dev.</span>
              </label>

              <label class="field">
                <span class="field__label">σφ true (rad)</span>
                <input id="inpRtruePhi" class="field__input" type="number" min="0" step="0.0001" value="0.003" />
                <span class="field__hint">Angle std dev.</span>
              </label>
            </div>
          </section>

          <!-- EKF assumptions -->
          <section class="card" aria-label="EKF assumptions">
            <div class="card__head">
              <h3 class="card__title">EKF assumptions</h3>
              <div class="card__right">
                <button id="btnResetFilter" class="btn btn--tiny" type="button">Reset EKF</button>
              </div>
            </div>

            <div class="grid2">
              <label class="field">
                <span class="field__label">σx0 (km)</span>
                <input id="inpSigX0" class="field__input" type="number" step="1e-4" value="0.5" />
                <span class="field__hint">Initial position std dev.</span>
              </label>

              <label class="field">
                <span class="field__label">σv0 (km/s)</span>
                <input id="inpSigV0" class="field__input" type="number" step="1e-5" value="0.01" />
                <span class="field__hint">Initial velocity std dev.</span>
              </label>
            </div>

            <div class="grid3">
              <label class="field">
                <span class="field__label">Qkf ax (km/s²)²</span>
                <input id="inpQkfAx" class="field__input" type="number" step="1e-10" value="1e-8" />
                <span class="field__hint">EKF acceleration variance in X.</span>
              </label>

              <label class="field">
                <span class="field__label">Qkf ay (km/s²)²</span>
                <input id="inpQkfAy" class="field__input" type="number" step="1e-10" value="1e-8" />
                <span class="field__hint">EKF acceleration variance in Y.</span>
              </label>

              <label class="field">
                <span class="field__label">α (consistency)</span>
                <input id="inpAlpha" class="field__input" type="number" min="0.01" max="0.2" step="0.01" value="0.05" />
                <span class="field__hint">χ² bounds level for NEES/NIS.</span>
              </label>
            </div>

            <div class="grid3">
              <label class="field">
                <span class="field__label">σρ kf (km)</span>
                <input id="inpRkfRho" class="field__input" type="number" min="0" step="0.01" value="0.2" />
                <span class="field__hint">Range std dev assumed by EKF.</span>
              </label>

              <label class="field">
                <span class="field__label">σρ̇ kf (km/s)</span>
                <input id="inpRkfRhod" class="field__input" type="number" min="0" step="0.0001" value="0.002" />
                <span class="field__hint">Range-rate std dev assumed by EKF.</span>
              </label>

              <label class="field">
                <span class="field__label">σφ kf (rad)</span>
                <input id="inpRkfPhi" class="field__input" type="number" min="0" step="0.0001" value="0.003" />
                <span class="field__hint">Angle std dev assumed by EKF.</span>
              </label>
            </div>
          </section>

          <!-- Thrust control -->
          <section class="card" aria-label="Thrust controls">
            <div class="card__head">
              <h3 class="card__title">Thrust control</h3>
              <div class="card__right">
                <span class="pill pill--warn mono" id="thrustStatus">THRUST: 0</span>
              </div>
            </div>

            <p class="card__note">
              Hold the buttons (or use arrow keys) to apply inertial-frame acceleration.
              The simulator includes a basic safety check to prevent Earth impact.
            </p>

            <div class="thruster">
              <div class="thruster__grid">
                <button id="thrUp" class="thruster__btn" type="button" aria-label="Thrust +Y">▲</button>
                <div class="thruster__mid">
                  <div class="thruster__craft" aria-hidden="true"></div>
                  <div class="thruster__readouts mono">
                    <div>ax: <span id="thrAx">0.0000</span> km/s²</div>
                    <div>ay: <span id="thrAy">0.0000</span> km/s²</div>
                  </div>
                </div>
                <button id="thrRight" class="thruster__btn" type="button" aria-label="Thrust +X">►</button>

                <button id="thrLeft" class="thruster__btn" type="button" aria-label="Thrust -X">◄</button>
                <button id="thrDown" class="thruster__btn" type="button" aria-label="Thrust -Y">▼</button>
                <button id="thrZero" class="thruster__btn thruster__btn--ghost" type="button">ZERO</button>
              </div>

              <div class="grid2">
                <label class="field">
                  <span class="field__label">Thrust magnitude (km/s²)</span>
                  <input id="inpThrustMag" class="field__input" type="number" min="0" step="0.0001" value="0.0005" />
                  <span class="field__hint">Acceleration applied while a thruster is held.</span>
                </label>

                <div class="field field--note">
                  <span class="field__label">Keyboard</span>
                  <div class="field__hint">
                    Use <span class="mono">← ↑ → ↓</span> to thrust, <span class="mono">Space</span> to zero.
                  </div>
                </div>
              </div>

              <!-- Hidden but used by JS (kept for backward compatibility) -->
              <input id="inpUx" type="hidden" value="0" />
              <input id="inpUy" type="hidden" value="0" />
            </div>
          </section>

          <!-- Hidden constants (Earth-only; JS reads them, but users don't edit) -->
          <input id="inpMu" type="hidden" value="398600" />
          <input id="inpRe" type="hidden" value="6378" />
          <input id="inpOmega" type="hidden" value="0.000072722052" />
          <input id="inpSeed" type="hidden" value="0" />
        </div>
      </aside>

      <!-- Right: plots + orbit -->
      <section class="panel panel--viz" aria-label="Visualization">
        <div class="panel__header">
          <h2 class="panel__title">Visualization</h2>
          <p class="panel__subtitle">
            White = truth, cyan = EKF estimate. Signal lines show measurements when stations are visible.
          </p>
        </div>

        <div class="panel__body panel__body--viz">
          <!-- Orbit view (stationary box; not draggable) -->
          <section class="orbitbox" aria-label="Orbit view">
            <div class="orbitbox__head">
              <div class="orbitbox__title">Orbit view</div>

              <div class="orbitbox__controls">
                <button id="btnZoomToCraft" class="btn btn--tiny" type="button">Zoom to craft</button>
                <button id="btnCenterView" class="btn btn--tiny" type="button">Center Earth</button>
                <button id="btnResetView" class="btn btn--tiny" type="button">Reset view</button>
              </div>
            </div>

            <div class="orbitbox__canvaswrap">
              <canvas id="orbitCanvas" class="canvas canvas--orbit" aria-label="Orbit canvas"></canvas>
            </div>

            <!-- Small station strip (12) -->
            <div class="stationstrip" aria-label="Ground station status strip">
              <div class="stationstrip__title">Ground stations</div>
              <div id="stationBoard" class="stationstrip__board" aria-label="Station tiles"></div>
            </div>
          </section>

          <!-- Tabs -->
          <nav class="tabs" aria-label="Plot tabs">
            <button class="tab is-active" type="button" data-tab="states">States</button>
            <button class="tab" type="button" data-tab="errors">Errors</button>
            <button class="tab" type="button" data-tab="meas">Measurements</button>
            <button class="tab" type="button" data-tab="cons">Consistency</button>
          </nav>

          <!-- Plot panes -->
          <section class="panes" aria-label="Plot panes">
            <div id="pane-states" class="pane is-active" data-pane="states">
              <div class="pane__head">
                <div class="pane__title">State vs estimate</div>
                <div class="pane__hint">Includes ±2σ bands (EKF covariance).</div>
              </div>
              <div class="pane__canvaswrap">
                <canvas id="plotStates" class="canvas canvas--plot" aria-label="States plot"></canvas>
              </div>
            </div>

            <div id="pane-errors" class="pane" data-pane="errors">
              <div class="pane__head">
                <div class="pane__title">Estimation error</div>
                <div class="pane__hint">Error with ±2σ bounds; used to diagnose filter tuning.</div>
              </div>
              <div class="pane__canvaswrap">
                <canvas id="plotErrors" class="canvas canvas--plot" aria-label="Errors plot"></canvas>
              </div>
            </div>

            <div id="pane-meas" class="pane" data-pane="meas">
              <div class="pane__head">
                <div class="pane__title">Measurements</div>
                <div class="pane__hint">Measured vs predicted points; colored by station ID.</div>
              </div>

              <div class="pane__measgrid">
                <div class="pane__canvaswrap">
                  <canvas id="plotMeas" class="canvas canvas--plot" aria-label="Measurement plot"></canvas>
                </div>

                <!-- Station board lives here on wide screens; CSS can move it on mobile -->
                <div class="meas__side">
                  <div class="meas__sidehead">
                    <div class="meas__sidetitle">Station activity</div>
                    <div class="meas__sidehint">Tiles pulse when contributing measurements.</div>
                  </div>
                  <div id="stationBoardMeas" class="stationgrid" aria-label="Station tiles in measurements panel">
                    <!-- JS may clone station tiles here; kept optional -->
                  </div>
                </div>
              </div>
            </div>

            <div id="pane-cons" class="pane" data-pane="cons">
              <div class="pane__head">
                <div class="pane__title">Consistency</div>
                <div class="pane__hint">NEES and NIS with χ² bounds for the selected α.</div>
              </div>
              <div class="pane__canvaswrap">
                <canvas id="plotCons" class="canvas canvas--plot" aria-label="Consistency plot"></canvas>
              </div>
            </div>

            <!-- Hidden (legacy) elements so older JS selectors don't crash -->
            <canvas id="plotTraj" class="canvas canvas--hidden" aria-hidden="true"></canvas>
            <div id="orbitCard" class="visually-hidden" aria-hidden="true"></div>
            <div id="orbitDragHandle" class="visually-hidden" aria-hidden="true"></div>
            <button id="btnResetLayout" class="visually-hidden" type="button" aria-hidden="true">Reset layout</button>
          </section>
        </div>
      </section>
    </div>
  </main>

  <footer class="footer" role="contentinfo">
    <div class="footer__inner">
      <span class="mono">2D orbit: x=[X,Ẋ,Y,Ẏ], μ=398600 km³/s², Rₑ=6378 km, ωₑ=2π/86400 rad/s</span>
    </div>
  </footer>

  <script src="orbit-sim.js"></script>
</body>
</html>
