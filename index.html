<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />

  <!-- Basic CSP for a static portfolio page (no external calls). -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self';
                 connect-src 'none';
                 object-src 'none';
                 base-uri 'self';
                 form-action 'none'">

  <title>Orbit Determination EKF Simulator</title>
  <link rel="stylesheet" href="orbit-sim.css" />
</head>

<body>
  <header class="topbar" role="banner">
    <div class="topbar__left">
      <div class="brand">
        <div class="brand__mark" aria-hidden="true"></div>
        <div class="brand__text">
          <div class="brand__title">ORBIT DETERMINATION</div>
          <div class="brand__subtitle">Extended Kalman Filter • Switching Ground Stations • 2D Two-Body Dynamics</div>
        </div>
      </div>
    </div>

    <div class="topbar__right">
      <div class="statusline" aria-live="polite">
        <div class="statuspill" id="statusRun">PAUSED</div>
        <div class="statuskv">
          <span class="k">t</span>
          <span class="v" id="readoutTime">0.0 s</span>
        </div>
        <div class="statuskv">
          <span class="k">k</span>
          <span class="v" id="readoutStep">0</span>
        </div>
        <div class="statuskv">
          <span class="k">visible</span>
          <span class="v" id="readoutVisible">0</span>
        </div>
      </div>
    </div>
  </header>

  <main class="layout" role="main">
    <!-- LEFT: controls + station board -->
    <section class="sidebar" aria-label="Controls and station board">
      <div class="panel">
        <div class="panel__title">Simulation Controls</div>
        <div class="panel__body">
          <div class="row row--wrap">
            <button class="btn btn--primary" id="btnToggleRun" type="button">Run</button>
            <button class="btn" id="btnStep" type="button">Step +10s</button>
            <button class="btn" id="btnReset" type="button">Reset</button>
          </div>

          <div class="row row--wrap">
            <div class="speedgroup" role="group" aria-label="Simulation speed">
              <button class="chip" id="spd1" type="button" data-speed="1">1×</button>
              <button class="chip" id="spd10" type="button" data-speed="10">10×</button>
              <button class="chip" id="spd100" type="button" data-speed="100">100×</button>
              <button class="chip" id="spd1000" type="button" data-speed="1000">1000×</button>
            </div>
          </div>

          <div class="grid2">
            <div class="field">
              <label for="inpDt">Δt (s)</label>
              <input id="inpDt" type="number" inputmode="decimal" min="1" step="1" value="10" />
              <div class="hint">Measurement cadence (also the EKF update cadence).</div>
            </div>

            <div class="field">
              <label for="inpSteps">Max steps</label>
              <input id="inpSteps" type="number" inputmode="numeric" min="50" step="50" value="1400" />
              <div class="hint">Stops automatically at K steps.</div>
            </div>
          </div>

          <div class="grid2">
            <div class="field">
              <label for="inpMu">μ (km³/s²)</label>
              <input id="inpMu" type="number" inputmode="decimal" step="1" value="398600" />
            </div>
            <div class="field">
              <label for="inpRe">Rₑ (km)</label>
              <input id="inpRe" type="number" inputmode="decimal" step="1" value="6378" />
            </div>
          </div>

          <div class="grid2">
            <div class="field">
              <label for="inpOmega">ωₑ (rad/s)</label>
              <input id="inpOmega" type="number" inputmode="decimal" step="0.0000001" value="0.000072722052" />
              <div class="hint">Default: 2π/86400.</div>
            </div>
            <div class="field">
              <label for="inpSeed">Random seed</label>
              <input id="inpSeed" type="number" inputmode="numeric" step="1" value="100" />
              <div class="hint">Reproducible noise.</div>
            </div>
          </div>

          <div class="divider"></div>

          <details class="accordion" open>
            <summary>Initial Conditions</summary>
            <div class="accordion__body">
              <div class="grid2">
                <div class="field">
                  <label for="inpAlt">Nominal altitude (km)</label>
                  <input id="inpAlt" type="number" inputmode="decimal" step="1" value="300" />
                  <div class="hint">Circular orbit baseline.</div>
                </div>
                <div class="field">
                  <label for="inpVelFactor">Velocity factor</label>
                  <input id="inpVelFactor" type="number" inputmode="decimal" step="0.01" value="1.00" />
                  <div class="hint">1.00 = circular. &gt;1 faster, &lt;1 slower.</div>
                </div>
              </div>

              <div class="grid2">
                <div class="field">
                  <label for="inpDx">ΔX (km)</label>
                  <input id="inpDx" type="number" inputmode="decimal" step="0.1" value="0" />
                </div>
                <div class="field">
                  <label for="inpDy">ΔY (km)</label>
                  <input id="inpDy" type="number" inputmode="decimal" step="0.1" value="0" />
                </div>
              </div>

              <div class="grid2">
                <div class="field">
                  <label for="inpDvx">ΔẊ (km/s)</label>
                  <input id="inpDvx" type="number" inputmode="decimal" step="0.00001" value="0" />
                </div>
                <div class="field">
                  <label for="inpDvy">ΔẎ (km/s)</label>
                  <input id="inpDvy" type="number" inputmode="decimal" step="0.00001" value="0" />
                </div>
              </div>

              <div class="row row--wrap">
                <button class="btn" id="btnApplyIC" type="button">Apply IC + Reset</button>
              </div>
            </div>
          </details>

          <details class="accordion" open>
            <summary>Noise (Truth Model)</summary>
            <div class="accordion__body">
              <div class="row row--wrap">
                <label class="toggle">
                  <input id="tglProcNoise" type="checkbox" checked />
                  <span>Enable process noise</span>
                </label>

                <label class="toggle">
                  <input id="tglMeasNoise" type="checkbox" checked />
                  <span>Enable measurement noise</span>
                </label>
              </div>

              <div class="grid2">
                <div class="field">
                  <label for="inpQtrueAx">Qtrue ax (km/s²)²</label>
                  <input id="inpQtrueAx" type="number" inputmode="decimal" step="1e-12" value="1e-10" />
                </div>
                <div class="field">
                  <label for="inpQtrueAy">Qtrue ay (km/s²)²</label>
                  <input id="inpQtrueAy" type="number" inputmode="decimal" step="1e-12" value="1e-10" />
                </div>
              </div>

              <div class="grid3">
                <div class="field">
                  <label for="inpRtrueRho">σρ (km)</label>
                  <input id="inpRtrueRho" type="number" inputmode="decimal" step="0.001" value="0.01" />
                </div>
                <div class="field">
                  <label for="inpRtrueRhod">σρ̇ (km/s)</label>
                  <input id="inpRtrueRhod" type="number" inputmode="decimal" step="0.000001" value="0.0001" />
                </div>
                <div class="field">
                  <label for="inpRtruePhi">σφ (rad)</label>
                  <input id="inpRtruePhi" type="number" inputmode="decimal" step="0.000001" value="0.0005" />
                </div>
              </div>
            </div>
          </details>

          <details class="accordion" open>
            <summary>EKF Settings (Live)</summary>
            <div class="accordion__body">
              <div class="grid2">
                <div class="field">
                  <label for="inpSigX0">σx0 (km)</label>
                  <input id="inpSigX0" type="number" inputmode="decimal" step="1e-6" value="1e-6" />
                </div>
                <div class="field">
                  <label for="inpSigV0">σv0 (km/s)</label>
                  <input id="inpSigV0" type="number" inputmode="decimal" step="1e-6" value="1e-5" />
                </div>
              </div>

              <div class="grid2">
                <div class="field">
                  <label for="inpQkfAx">Qkf ax (km/s²)²</label>
                  <input id="inpQkfAx" type="number" inputmode="decimal" step="1e-12" value="1e-10" />
                  <div class="hint">Applied immediately (next prediction).</div>
                </div>
                <div class="field">
                  <label for="inpQkfAy">Qkf ay (km/s²)²</label>
                  <input id="inpQkfAy" type="number" inputmode="decimal" step="1e-12" value="1e-10" />
                </div>
              </div>

              <div class="grid3">
                <div class="field">
                  <label for="inpRkfRho">σρ (km)</label>
                  <input id="inpRkfRho" type="number" inputmode="decimal" step="0.001" value="0.01" />
                  <div class="hint">Applied immediately (next update).</div>
                </div>
                <div class="field">
                  <label for="inpRkfRhod">σρ̇ (km/s)</label>
                  <input id="inpRkfRhod" type="number" inputmode="decimal" step="0.000001" value="0.0001" />
                </div>
                <div class="field">
                  <label for="inpRkfPhi">σφ (rad)</label>
                  <input id="inpRkfPhi" type="number" inputmode="decimal" step="0.000001" value="0.0005" />
                </div>
              </div>

              <div class="grid2">
                <div class="field">
                  <label for="inpAlpha">Consistency α</label>
                  <input id="inpAlpha" type="number" inputmode="decimal" step="0.01" min="0.01" max="0.20" value="0.05" />
                  <div class="hint">Used for NEES/NIS confidence bounds.</div>
                </div>

                <div class="field">
                  <label for="btnResetFilter">Filter</label>
                  <button class="btn" id="btnResetFilter" type="button">Reset EKF only</button>
                  <div class="hint">Keeps truth running; restarts EKF at current truth state.</div>
                </div>
              </div>
            </div>
          </details>

          <details class="accordion">
            <summary>Thrust / Disturbance (Optional)</summary>
            <div class="accordion__body">
              <div class="grid2">
                <div class="field">
                  <label for="inpUx">uₓ (km/s²)</label>
                  <input id="inpUx" type="number" inputmode="decimal" step="1e-9" value="0" />
                  <div class="hint">Applied to both truth + EKF dynamics (ZOH).</div>
                </div>
                <div class="field">
                  <label for="inpUy">uᵧ (km/s²)</label>
                  <input id="inpUy" type="number" inputmode="decimal" step="1e-9" value="0" />
                </div>
              </div>
              <div class="hint">Leave at zero unless you want to demo controlled disturbances.</div>
            </div>
          </details>

          <div class="divider"></div>

          <div class="panel__title">Key Readouts</div>
          <div class="kvgrid" aria-label="Key readouts">
            <div class="kv"><div class="k">ρ</div><div class="v" id="roRho">—</div></div>
            <div class="kv"><div class="k">ρ̇</div><div class="v" id="roRhod">—</div></div>
            <div class="kv"><div class="k">φ</div><div class="v" id="roPhi">—</div></div>

            <div class="kv"><div class="k">NEES</div><div class="v" id="roNEES">—</div></div>
            <div class="kv"><div class="k">NIS</div><div class="v" id="roNIS">—</div></div>
            <div class="kv"><div class="k">|e|</div><div class="v" id="roErrNorm">—</div></div>
          </div>
        </div>
      </div>

      <div class="panel panel--stations">
        <div class="panel__title">Ground Stations (Switching Measurement Set)</div>
        <div class="panel__body">
          <div class="stationboard" id="stationBoard" aria-label="Station board"></div>
          <div class="hint" style="margin-top:10px;">
            Bright tiles are visible stations. A pulse indicates a measurement taken this step.
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: visualization + plots -->
    <section class="vis" aria-label="Visualization and plots">
      <div class="visgrid">
        <!-- Draggable orbit card -->
        <article class="card card--draggable" id="orbitCard" aria-label="Orbit viewport card">
          <div class="card__header draghandle" id="orbitDragHandle" aria-label="Drag to move orbit window">
            <div class="card__title">
              Orbit View (Pan + Zoom)
              <span class="sub">Drag canvas to pan • Wheel / pinch to zoom</span>
            </div>
            <div class="card__tools">
              <button class="iconbtn" id="btnCenterView" type="button" title="Center view">⦿</button>
              <button class="iconbtn" id="btnResetView" type="button" title="Reset zoom">⌖</button>
              <button class="iconbtn" id="btnResetLayout" type="button" title="Reset window position">↺</button>
            </div>
          </div>
          <div class="card__body">
            <canvas id="orbitCanvas" width="640" height="420" aria-label="Orbit canvas"></canvas>
            <div class="orbitlegend" aria-hidden="true">
              <div><span class="sw sw--truth"></span>Truth</div>
              <div><span class="sw sw--est"></span>EKF</div>
              <div><span class="sw sw--sig"></span>Signal</div>
              <div><span class="sw sw--sta"></span>Station</div>
            </div>
          </div>
        </article>

        <!-- Tabs for plots -->
        <article class="card card--plots" aria-label="Plots">
          <div class="card__header">
            <div class="tabs" role="tablist" aria-label="Plot tabs">
              <button class="tab is-active" role="tab" aria-selected="true" id="tabStates" data-tab="states" type="button">States</button>
              <button class="tab" role="tab" aria-selected="false" id="tabErrors" data-tab="errors" type="button">Errors</button>
              <button class="tab" role="tab" aria-selected="false" id="tabMeas" data-tab="meas" type="button">Measurements</button>
              <button class="tab" role="tab" aria-selected="false" id="tabTraj" data-tab="traj" type="button">Trajectory</button>
              <button class="tab" role="tab" aria-selected="false" id="tabCons" data-tab="cons" type="button">Consistency</button>
            </div>
          </div>

          <div class="card__body card__body--plots">
            <div class="plotpane is-active" id="pane-states" role="tabpanel" aria-labelledby="tabStates">
              <canvas id="plotStates" width="980" height="520" aria-label="States plot"></canvas>
              <div class="plotnote">Truth vs EKF estimate with ±2σ bounds (matches your MATLAB Plot 1).</div>
            </div>

            <div class="plotpane" id="pane-errors" role="tabpanel" aria-labelledby="tabErrors">
              <canvas id="plotErrors" width="980" height="520" aria-label="Errors plot"></canvas>
              <div class="plotnote">EKF estimation error with ±2σ bounds (matches your MATLAB Plot 2).</div>
            </div>

            <div class="plotpane" id="pane-meas" role="tabpanel" aria-labelledby="tabMeas">
              <canvas id="plotMeas" width="980" height="520" aria-label="Measurements plot"></canvas>
              <div class="plotnote">Noisy measurements vs EKF predicted measurements (matches your MATLAB Plot 3).</div>
            </div>

            <div class="plotpane" id="pane-traj" role="tabpanel" aria-labelledby="tabTraj">
              <canvas id="plotTraj" width="980" height="520" aria-label="Trajectory plot"></canvas>
              <div class="plotnote">True vs EKF XY trajectory, Earth disk, and station ring (matches your MATLAB Plot 4).</div>
            </div>

            <div class="plotpane" id="pane-cons" role="tabpanel" aria-labelledby="tabCons">
              <canvas id="plotCons" width="980" height="520" aria-label="Consistency plot"></canvas>
              <div class="plotnote">NEES and NIS consistency diagnostics (portfolio-grade validation).</div>
            </div>
          </div>
        </article>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footer__left">
      Portfolio demo: physics + estimation + switching measurement sets • No external libraries • Runs fully client-side.
    </div>
    <div class="footer__right">
      Tip: Set speed to 10× or 100× for fast demos. Use 1× for “real-time” cadence.
    </div>
  </footer>

  <script src="orbit-sim.js"></script>
</body>
</html>
